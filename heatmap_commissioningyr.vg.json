{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "Coal units by Commissioning Year",
  "width": 900,
  "height": 420,

  "data": {
    "url": "https://raw.githubusercontent.com/adisomaroo13/DataVisualisation2/main/GlobalPowerPlantDB.csv",
    "format": {
      "type": "csv",
      "parse": {
        "commissioning_year": "number",
        "capacity_mw": "number"
      }
    }
  },

  "params": [
    {
      "name": "cap_min",
      "value": 50,
      "bind": { "input": "range", "min": 50, "max": 2000, "step": 50, "name": "Min capacity (MW): " }
    }
  ],

  "transform": [
    { "filter": "isValid(datum.commissioning_year) && isValid(datum.capacity_mw)" },
    { "filter": "datum.commissioning_year >= 1960 && datum.commissioning_year <= 2024" },
    { "filter": "datum.capacity_mw >= cap_min && datum.capacity_mw <= 2000" },
  
    { "bin": { "step": 5 },   "field": "commissioning_year", "as": "year_b" },
    { "bin": { "step": 100 }, "field": "capacity_mw",         "as": "cap_b" },
  
    { "aggregate": [{ "op": "count", "as": "units" }], "groupby": ["year_b", "cap_b"] },
  
    { "impute": "units", "key": "year_b", "groupby": ["cap_b"], "value": 0,
      "keyvals": [1960,1965,1970,1975,1980,1985,1990,1995,2000,2005,2010,2015,2020] },
  
    { "impute": "units", "key": "cap_b", "groupby": ["year_b"], "value": 0,
      "keyvals": [0,100,200,300,400,500,600,700,800,900,1000,1100,1200,1300,1400,1500,1600,1700,1800,1900] },
  
    { "calculate": "datum.year_b + 5",  "as": "year_b_end" },
    { "calculate": "datum.cap_b + 100", "as": "cap_b_end" },
    { "calculate": "round(datum.year_b) + '–' + round(datum.year_b_end)", "as": "year_range" },
    { "calculate": "round(datum.cap_b) + '–' + round(datum.cap_b_end) + ' MW'", "as": "cap_range" }
  ],
  "mark": { "type": "rect" },

  "encoding": {
    "x": {
      "field": "year_b",
      "type": "quantitative",
      "title": "Commissioning year",
      "scale": { "domain": [1960, 2025], "zero": false, "nice": false },
      "axis": { "values": [1960,1970,1980,1990,2000,2010,2020], "labelFlush": false }
    },
    "x2": { "field": "year_b_end" },

    "y": {
      "field": "cap_b",
      "type": "quantitative",
      "title": "Unit capacity",
      "scale": { "domain": [0, 2000], "zero": false, "nice": false },
      "axis": { "values": [0,200,400,600,800,1000,1200,1400,1600,1800,2000] }
    },
    "y2": { "field": "cap_b_end" },

    "color": {
      "condition": { "test": "datum.units === 0", "value": "#d1d5db" },   
      "field": "units",
      "type": "quantitative",
      "title": "Units",
      "scale": { "scheme": "tealblues" }
    },

    "tooltip": [
      { "field": "year_range", "title": "Commissioning years" },
      { "field": "cap_range",  "title": "Unit capacity range" },
      { "field": "units",      "title": "Units commissioned", "format": "," }
    ]
  },

  "config": {
    "background": "#ffffff",
    "axis": {
      "grid": true,
      "labelColor": "#0f172a",
      "titleColor": "#0f172a",
      "gridColor": "#e2e8f0"
    },
    "legend": { "labelColor": "#0f172a", "titleColor": "#0f172a" },
    "view": { "stroke": null }
  }
}
