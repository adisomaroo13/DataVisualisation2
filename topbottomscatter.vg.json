{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "title": "Clean electricity share (2024) - Top & Bottom 5",
    "width": 500,
    "height": 300,
  
    "data": {
      "url": "https://raw.githubusercontent.com/adisomaroo13/DataVisualisation2/main/GER2025_2024_clean_country_percent.csv",
      "format": { "type": "csv", "parse": { "Value": "number" } }
    },
  
    "transform": [
      { "filter": "isValid(datum.Value)" },
      { "calculate": "datum['Country name'] ? datum['Country name'] : datum['Country code']", "as": "Label" },

      { "window": [{"op":"rank","as":"r"}], "sort": [{"field":"Value","order":"descending"}] },

      { "joinaggregate": [
          {"op":"count","as":"N"},
          {"op":"median","field":"Value","as":"medianValue"}
        ]
      },
      { "calculate": "(datum.N - datum.r + 0.5) / datum.N", "as": "pct" },
      { "calculate": "datum.Value >= datum.medianValue ? 'Above median' : 'Below median'", "as": "above" },
  
      { "calculate": "datum.r <= 5 ? 'Top 5' : (datum.r >= datum.N - 4 ? 'Bottom 5' : 'Other')", "as": "cat" },

      { "calculate": "random()", "as": "jitter" }
    ],
  
    "layer": [
      {
        "mark": {"type": "rule", "stroke": "#94a3b8", "strokeDash": [6,4]},
        "encoding": { "x": {"field":"medianValue","type":"quantitative"} }
      },
  
      {
        "mark": {"type": "circle", "size": 70, "opacity": 0.8},
        "encoding": {
          "x": {
            "field": "Value", "type": "quantitative",
            "title": "Clean electricity share (%)",
            "scale": {"domain": [0, 100]}
          },
          "y": {
            "field": "jitter", "type": "quantitative",
            "axis": null,
            "scale": {"domain": [0,1]}
          },
          "color": {
            "field": "cat", "type": "nominal", "title": null,
            "scale": { "range": ["#0ea5a4", "#f59e0b", "#94a3b8"] },  
            "sort": ["Top 5","Other","Bottom 5"]
          },
          "tooltip": [
            {"field":"Area","title":"Country"},
            {"field":"Value","title":"Clean share (%)","format":".1f"},
            {"field":"r","title":"Global rank"},
            {"field":"pct","title":"Percentile","format":".0%"},
            {"field":"above","title":"vs median"}
          ]
        }
      },

      {
        "transform": [{ "filter": "datum.r == 1" }],
        "mark": {"type":"text","dx": 6,"dy": -6,"fontSize": 12,"fontWeight": "bold","color": "#b45309"},
        "encoding": { "x": {"field":"Value","type":"quantitative"}, "y": {"field":"jitter","type":"quantitative"}, "text": {"value":"Highest"} }
      }
    ],
  
    "config": { "view": {"stroke": null}, "axis": {"grid": true} }
  }
  